<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Barangay Requirements — Test Runner</title>
  <style>body{font-family:Arial,Helvetica,sans-serif;margin:20px}pre{background:#f1f1f1;padding:12px;border-radius:6px;white-space:pre-wrap}</style>
</head>
<body>
  <h2>Barangay Requirements — Automated Test Runner</h2>
  <p>Open this file in your browser (via Live Server). It will load <code>src/forms/barangay-requirements.html</code> in an iframe and run tests for requirement rendering and proceed flow. Results will appear below.</p>

  <iframe id="frame" src="../src/forms/barangay-requirements.html" width="720" height="760" style="border:1px solid #ddd;border-radius:8px"></iframe>

  <h3>Results</h3>
  <div style="display:flex;gap:12px;align-items:center;margin-bottom:12px">
    <button id="runBtn" style="background:#1976d2;color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer">Run Tests</button>
    <span id="summary" style="font-weight:600;color:#1976d2"></span>
  </div>
  <div id="results" style="display:grid;gap:8px"></div>
  <pre id="output" style="margin-top:12px;display:none"></pre>

  <script>
    const iframe = document.getElementById('frame');
    const resultsEl = document.getElementById('results');
    const runBtn = document.getElementById('runBtn');
    const summary = document.getElementById('summary');
    const out = document.getElementById('output');

    function card(title, ok, details){
      const c = document.createElement('div');
      c.style.border='1px solid #e0e0e0'; c.style.padding='12px'; c.style.borderRadius='8px'; c.style.background='#fff';
      const t = document.createElement('div'); t.textContent = title; t.style.fontWeight='700'; t.style.color='#1976d2'; c.appendChild(t);
      const s = document.createElement('div'); s.textContent = ok? 'PASS':'FAIL'; s.style.fontWeight='700'; s.style.color = ok? '#2e7d32':'#c62828'; c.appendChild(s);
      const d = document.createElement('pre'); d.style.background='#f7f7f7'; d.style.padding='8px'; d.style.borderRadius='6px'; d.textContent = JSON.stringify(details, null, 2); c.appendChild(d);
      return c;
    }

    runBtn.addEventListener('click', runTests);

    async function runTests(){
      resultsEl.innerHTML=''; summary.textContent='Running...'; out.style.display='none';
      const res = await runAllChecks();
      let passCount = 0; const total = Object.keys(res.results).length;
      for (const [k,v] of Object.entries(res.results)){
        resultsEl.appendChild(card(k, v.ok, v.details)); if (v.ok) passCount++;
      }
      summary.textContent = `${passCount}/${total} passed`;
      out.style.display = 'block'; out.textContent = JSON.stringify(res, null, 2);
    }

    function waitForIframeReady(win, timeoutMs = 3000){
      return new Promise((resolve, reject) => {
        const start = Date.now();
        (function check(){
          try{
            if (win.document && win.document.readyState === 'complete') return resolve(true);
          }catch(e){}
          if (Date.now() - start > timeoutMs) return reject('iframe-not-ready');
          setTimeout(check, 100);
        })();
      });
    }

    async function runAllChecks(){
      iframe.src = `../src/forms/barangay-requirements.html?cb=${Date.now()}`;
      await new Promise(r => { iframe.onload = r; });
      const win = iframe.contentWindow;
      try{ await waitForIframeReady(win, 3000); } catch(e){ return { error: e, results: {} }; }
      const doc = win.document;
      const results = {};

      // 1) When paymentInfo.service is set, requirements render
      try{
        win.localStorage.setItem('paymentInfo', JSON.stringify({ service: 'Barangay Clearance', name: 'Test User' }));
        // reload to pick up storage
        iframe.src = `../src/forms/barangay-requirements.html?cb=${Date.now()}`;
        await new Promise(r => { iframe.onload = r; });
        const ul = iframe.contentWindow.document.getElementById('req-list');
        const items = Array.from(ul.children).map(li => li.textContent);
        const ok = items.length >= 1 && items.includes('Valid ID (Government-issued)');
        results['render-with-service'] = { ok, details: { items } };
      }catch(e){ results['render-with-service'] = { ok:false, details: { error: String(e) } } }

      // 2) Proceed to payment sets storage and redirects
      try{
        // ensure service present
        win.localStorage.setItem('paymentInfo', JSON.stringify({ service: 'Barangay Clearance', name: 'Test User' }));
        // reload to ensure handlers bound
        iframe.src = `../src/forms/barangay-requirements.html?cb=${Date.now()}`;
        await new Promise(r => { iframe.onload = r; });
        const fdoc = iframe.contentWindow.document;
        const form = fdoc.querySelector('form');
        // click submit
        form.dispatchEvent(new iframe.contentWindow.Event('submit', { bubbles: true, cancelable: true }));
        // wait for redirect
        await new Promise(r => setTimeout(r, 700));
        const redirected = iframe.contentWindow.location.pathname.endsWith('payment-methods.html') || iframe.contentWindow.location.href.indexOf('payment-methods.html')>=0;
        const stored = JSON.parse(iframe.contentWindow.localStorage.getItem('paymentInfo') || '{}');
        results['proceed-redirect'] = { ok: redirected && stored.service === 'Barangay Clearance', details: { redirected, stored } };
      }catch(e){ results['proceed-redirect'] = { ok:false, details: { error: String(e) } } }

      // 3) When no service selected, clicking proceed prompts and accepts default -> service set
      try{
        // clear storage
        win.localStorage.removeItem('paymentInfo');
        // reload
        iframe.src = `../src/forms/barangay-requirements.html?cb=${Date.now()}`;
        await new Promise(r => { iframe.onload = r; });
        const fwin = iframe.contentWindow;
        // stub confirm to auto-accept
        fwin.confirm = () => true;
        const fdoc2 = fwin.document;
        const form2 = fdoc2.querySelector('form');
        form2.dispatchEvent(new fwin.Event('submit', { bubbles: true, cancelable: true }));
        await new Promise(r => setTimeout(r, 700));
        const stored2 = JSON.parse(fwin.localStorage.getItem('paymentInfo') || '{}');
        const manualLinkVisible = !!fdoc2.getElementById('manual-pay-link') && fdoc2.getElementById('manual-pay-link').style.display !== 'none';
        results['no-service-default-accept'] = { ok: stored2.service === 'Barangay Clearance', details: { stored: stored2, manualLinkVisible } };
      }catch(e){ results['no-service-default-accept'] = { ok:false, details: { error: String(e) } } }

      // 4) Upload fallback (simulate file by creating a Blob and invoking proceedToPayment)
      try{
        win.localStorage.setItem('paymentInfo', JSON.stringify({ service: 'Barangay Clearance', name: 'Test User' }));
        iframe.src = `../src/forms/barangay-requirements.html?cb=${Date.now()}`;
        await new Promise(r => { iframe.onload = r; });
        const fwin3 = iframe.contentWindow;
        const fdoc3 = fwin3.document;
        const fileInput = fdoc3.getElementById('requirement-image');
        // create a dummy file via DataTransfer if supported
        let blob = new Blob(['dummy content'], { type: 'text/plain' });
        try{
          const file = new File([blob], 'test.txt', { type: 'text/plain' });
          const dt = new DataTransfer(); dt.items.add(file); fileInput.files = dt.files;
        }catch(e){
          // some browsers may not allow assigning files; fallback skip
        }
        // submit
        fdoc3.querySelector('form').dispatchEvent(new fwin3.Event('submit', { bubbles: true, cancelable: true }));
        await new Promise(r => setTimeout(r, 1200));
        const uploaded = JSON.parse(fwin3.localStorage.getItem('uploadedFiles') || '[]');
        const usedLocal = uploaded.some(u => u.local === true || u.url && u.url.startsWith('data:'));
        results['upload-fallback'] = { ok: uploaded.length>=0, details: { uploadedCount: uploaded.length, usedLocal } };
      }catch(e){ results['upload-fallback'] = { ok:false, details: { error: String(e) } } }

      // collect debug logs from iframe localStorage
      let logs = {};
      try { logs.lastProceedLog = JSON.parse(iframe.contentWindow.localStorage.getItem('lastProceedLog') || '[]'); } catch(e) { logs.lastProceedLog = 'unavailable: '+String(e); }
      try { logs.lastProceedAction = iframe.contentWindow.localStorage.getItem('lastProceedAction'); } catch(e) { logs.lastProceedAction = 'unavailable'; }
      try { logs.lastError = iframe.contentWindow.localStorage.getItem('lastError'); } catch(e) { logs.lastError = 'unavailable'; }
      return { timestamp: new Date().toISOString(), results, logs };
    }

    // auto-run once
    runTests();
  </script>
</body>
</html>